<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>邂｡逅・ｼ・en繝ｩ繧､繧ｯ蝓ｷ遲・お繝・ぅ繧ｿ・・/title>
    <link rel="stylesheet" href="styles/common.css" />
    <link rel="stylesheet" href="styles/admin.css" />
  </head>
  <body>
    <header class="app-header">
      <a class="btn" href="index.html">竊・繝医ャ繝・/a>
      <h1>Zen繝ｩ繧､繧ｯ繧ｨ繝・ぅ繧ｿ</h1>
      <div class="header-actions">
        <span id="char-count" class="muted">0 譁・ｭ・/span>
        <button id="btn-theme" class="icon-btn" title="繝・・繝櫁ｨｭ螳・>耳</button>
        <button id="btn-toggle-sidebar" class="icon-btn" title="繝・・繝ｫ">笘ｰ</button>
      </div>
    </header>

    <aside id="sidebar" class="sidebar" hidden>
      <div class="sidebar-inner">
        <h2>繝・・繝ｫ / 菫晏ｭ・/h2>
        <label class="field">
          <span>繧ｿ繧､繝医Ν</span>
          <input id="title-input" type="text" placeholder="辟｡鬘・ />
        </label>

        <label class="field">
          <span>菫晏ｭ伜・・医せ繝医Ξ繝ｼ繧ｸ・・/span>
          <select id="storage-provider-select">
            <option value="idb">IndexedDB・域耳螂ｨ・・/option>
            <option value="local">LocalStorage</option>
          </select>
        </label>

        <!-- 譖ｸ蠑上ヤ繝ｼ繝ｫ縺ｯ繝輔Ο繝ｼ繝・ぅ繝ｳ繧ｰ繝舌・縺ｫ蛻・屬 -->

        <div class="actions">
          <button id="btn-save-simple" class="btn">繧ｷ繝ｳ繝励Ν菫晏ｭ・/button>
          <button id="btn-load-simple" class="btn">繧ｷ繝ｳ繝励Ν隱ｭ霎ｼ</button>
          <button id="btn-save-full" class="btn btn-accent">螳悟・菫晏ｭ・/button>
          <button id="btn-load-full" class="btn">螳悟・隱ｭ霎ｼ</button>
          <button id="btn-export" class="btn">繧ｨ繧ｯ繧ｹ繝昴・繝・JSON)</button>
          <label class="btn file-label">
            繧､繝ｳ繝昴・繝・JSON)
            <input id="file-import" type="file" accept="application/json" hidden />
          </label>
          <button id="btn-saves-list" class="btn">菫晏ｭ倅ｸ隕ｧ</button>
        </div>

        <section id="validation-panel" class="card" hidden>
          <h3>讀懆ｨｼ繝｡繝・そ繝ｼ繧ｸ</h3>
          <ul id="validation-list"></ul>
        </section>

    <!-- 菫晏ｭ倅ｸ隕ｧ繝代ロ繝ｫ -->
    <section id="saves-panel" class="saves-panel" hidden>
      <header class="memos-header">
        <h3>菫晏ｭ倅ｸ隕ｧ</h3>
        <button id="saves-refresh" class="btn">譖ｴ譁ｰ</button>
        <button id="saves-close" class="icon-btn" title="髢峨§繧・>笨・/button>
      </header>
      <div id="saves-list" class="memos-list"></div>
    </section>

        <section id="editor-settings" class="card">
          <h3>繧ｨ繝・ぅ繧ｿ險ｭ螳・/h3>
          <div class="field">
            <label class="muted"><input id="cfg-autoscroll-enabled" type="checkbox" /> 閾ｪ蜍輔せ繧ｯ繝ｭ繝ｼ繝ｫ繧呈怏蜉ｹ縺ｫ縺吶ｋ</label>
          </div>
          <div class="field">
            <span>螳牙・鬆伜沺・井ｸ奇ｼ・<small id="cfg-safe-top-label">20%</small></span>
            <input id="cfg-safe-top" type="range" min="5" max="40" step="1" value="20" />
          </div>
          <div class="field">
            <span>螳牙・鬆伜沺・井ｸ具ｼ・<small id="cfg-safe-bottom-label">60%</small></span>
            <input id="cfg-safe-bottom" type="range" min="55" max="90" step="1" value="60" />
          </div>
          <div class="field">
            <label class="muted"><input id="cfg-ink-enabled" type="checkbox" /> 蜈･蜉帙い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ繧呈怏蜉ｹ縺ｫ縺吶ｋ</label>
          </div>
          <div class="field">
            <span>繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ譎る俣 <small id="cfg-ink-duration-label">160ms</small></span>
            <input id="cfg-ink-duration" type="range" min="0" max="400" step="10" value="160" />
          </div>
          <div class="ne-row">
            <button id="cfg-save" class="btn btn-accent">險ｭ螳壹ｒ菫晏ｭ・/button>
            <button id="cfg-reset" class="btn">譌｢螳壹↓謌ｻ縺・/button>
          </div>
        </section>

        <section id="node-editor" class="card">
          <h3>繝弱・繝臥ｷｨ髮・ｼ・VP・・/h3>
          <div class="ne-actions">
            <button id="ne-load" class="btn">蜿冶ｾｼ・・gp_game_data・・/button>
            <button id="ne-validate" class="btn">讀懆ｨｼ</button>
            <button id="ne-save" class="btn btn-accent">驕ｩ逕ｨ菫晏ｭ・/button>
            <button id="ne-export" class="btn">JSON蜃ｺ蜉・/button>
          </div>
          <div class="ne-banner" id="ne-dirty-banner" hidden>譛ｪ菫晏ｭ倥・螟画峩縺後≠繧翫∪縺呻ｼ・trl+S 縺ｧ菫晏ｭ假ｼ・/div>
          <div class="field">
            <span>髢句ｧ九ヮ繝ｼ繝・/span>
            <select id="ne-start-select"></select>
          </div>
          <div class="field ne-unresolved" id="ne-unresolved-panel" hidden>
            <span>譛ｪ隗｣豎ｺ target 荳隕ｧ</span>
            <ul id="ne-unresolved-list"></ul>
          </div>
          <div class="field">
            <span>繝弱・繝蛾∈謚・/span>
            <div class="ne-row">
              <select id="ne-node-select"></select>
              <button id="ne-add-node" class="btn">繝弱・繝芽ｿｽ蜉</button>
              <button id="ne-remove-node" class="btn">繝弱・繝牙炎髯､</button>
            </div>
          </div>
          <div class="field">
            <span>繝弱・繝迂D</span>
            <input id="ne-node-id" type="text" placeholder="node:id" />
          </div>
          <div class="field">
            <span>繧ｿ繧､繝医Ν</span>
            <input id="ne-node-title" type="text" placeholder="繧ｿ繧､繝医Ν" />
          </div>
          <div class="field">
            <span>譛ｬ譁・/span>
            <textarea id="ne-node-text" rows="4" placeholder="繝・く繧ｹ繝・></textarea>
          </div>
          <div class="field">
            <span>驕ｸ謚櫁い</span>
            <div id="ne-choices" class="ne-choices"></div>
            <button id="ne-add-choice" class="btn">驕ｸ謚櫁い繧定ｿｽ蜉</button>
          </div>
          <datalist id="ne-node-id-list"></datalist>
          <div class="field">
            <span>驛ｨ蛻・お繧ｯ繧ｹ繝昴・繝茨ｼ亥芦驕泌庄閭ｽ繧ｵ繝悶げ繝ｩ繝包ｼ・/span>
            <div class="ne-row">
              <select id="ne-export-multiselect" multiple size="6" style="flex:1"></select>
              <div class="ne-subactions" style="display:grid; gap:6px;">
                <button id="ne-export-select-all" class="btn">蜈ｨ驕ｸ謚・/button>
                <button id="ne-export-select-none" class="btn">蜈ｨ隗｣髯､</button>
                <button id="ne-export-partial" class="btn">驕ｸ謚槭°繧峨お繧ｯ繧ｹ繝昴・繝・/button>
              </div>
            </div>
          </div>
        </section>

        <section id="mermaid-panel" class="card">
          <h3>蛻・ｲ舌・繝ｬ繝薙Η繝ｼ・・ermaid・・/h3>
          <div class="actions" style="grid-template-columns: repeat(4, 1fr);">
            <button id="ne-mermaid-gen" class="btn">逕滓・</button>
            <button id="ne-mermaid-render" class="btn">謠冗判</button>
            <button id="ne-mermaid-copy" class="btn">繧ｳ繝斐・</button>
            <button id="ne-mermaid-download" class="btn">SVG繝繧ｦ繝ｳ繝ｭ繝ｼ繝・/button>
          </div>
          <div class="ne-row" style="margin:6px 0 0;">
            <button id="ne-mermaid-open" class="btn">蛻･繧ｦ繧｣繝ｳ繝峨え縺ｧ髢九￥</button>
            <div class="spacer"></div>
          </div>
          <div class="field">
            <span>蟇ｾ雎｡</span>
            <div class="ne-row">
              <select id="ne-mermaid-scope">
                <option value="all">蜈ｨ菴・/option>
                <option value="from_start">髢句ｧ九°繧牙芦驕・/option>
                <option value="from_selected">驕ｸ謚槭ヮ繝ｼ繝峨ｒseed</option>
              </select>
              <select id="ne-mermaid-seed" multiple size="5" style="flex:1" disabled></select>
            </div>
            <label class="muted"><input id="ne-mermaid-show-labels" type="checkbox" checked /> 繧ｨ繝・ず縺ｫ驕ｸ謚櫁い繝ｩ繝吶Ν繧定｡ｨ遉ｺ</label>
          </div>
          <div class="field">
            <span>繝ｬ繧､繧｢繧ｦ繝・/span>
            <div class="ne-row">
              <select id="ne-mermaid-dir">
                <option value="TD">Top-Down (TD)</option>
                <option value="LR">Left-Right (LR)</option>
                <option value="TB">Top-Bottom (TB)</option>
                <option value="RL">Right-Left (RL)</option>
              </select>
              <label class="muted"><input id="ne-mermaid-mark-unreachable" type="checkbox" checked /> 蛻ｰ驕比ｸ崎・繝弱・繝峨ｒ蠑ｷ隱ｿ</label>
            </div>
          </div>
          <label class="field">
            <span>Mermaid 繧ｽ繝ｼ繧ｹ</span>
            <textarea id="ne-mermaid-src" rows="6" placeholder="flowchart TD..." style="width:100%;"></textarea>
          </label>
          <div class="mermaid-view" id="ne-mermaid-view"></div>
          <p class="muted" style="margin-top:6px;">
            豕ｨ: 繧ｪ繝輔Λ繧､繝ｳ迺ｰ蠅・〒縺ｯ謠冗判縺瑚｡後ｏ繧後↑縺・ｴ蜷医′縺ゅｊ縺ｾ縺吶ゅ◎縺ｮ蝣ｴ蜷医〒繧ゅた繝ｼ繧ｹ縺ｯ繧ｳ繝斐・蜿ｯ閭ｽ縺ｧ縺吶・          </p>
        </section>

        <details>
          <summary>繝倥Ν繝・/summary>
          <ul>
            <li>繧ｨ繝・ぅ繧ｿ縺ｯ Zen 繝ｩ繧､繧ｯ縺ｧ縲∵悽譁・↓髮・ｸｭ縺ｧ縺阪∪縺吶・/li>
            <li>譁・ｭ玲焚繧ｫ繧ｦ繝ｳ繝医・閾ｪ蜍墓峩譁ｰ縺輔ｌ縺ｾ縺吶・/li>
            <li>菫晏ｭ倥・繝悶Λ繧ｦ繧ｶ縺ｮ localStorage 繧剃ｽｿ逕ｨ縺励∪縺吶・/li>
          </ul>
        </details>
      </div>
    </aside>

    <main class="editor-container">
      <div id="editor" class="editor" contenteditable spellcheck="false"></div>
    </main>

    <div id="theme-panel" class="theme-panel" hidden></div>

    <!-- 繝輔Ο繝ｼ繝・ぅ繝ｳ繧ｰ・壽嶌蠑上ヤ繝ｼ繝ｫ繝舌・ -->
    <div id="formatbar" class="formatbar-floating">
      <button data-cmd="bold" title="螟ｪ蟄・><b>B</b></button>
      <button data-cmd="italic" title="譁應ｽ・><i>I</i></button>
      <button data-cmd="underline" title="荳狗ｷ・><u>U</u></button>
      <span class="spacer"></span>
      <button data-cmd="justifyLeft" title="蟾ｦ謠・∴">筺ｸ</button>
      <button data-cmd="justifyCenter" title="荳ｭ螟ｮ">竍・/button>
      <button data-cmd="justifyRight" title="蜿ｳ謠・∴">筺ｹ</button>
    </div>

    <!-- 繝輔Ο繝ｼ繝・ぅ繝ｳ繧ｰ・壽桃菴懶ｼ・en/繧ｵ繧､繝峨ヰ繝ｼ/繝・・繝橸ｼ・-->
    <div class="floating-controls">
      <button id="btn-quick-zen" class="icon-btn" title="Zen蛻・崛">ｧ・/button>
      <button id="btn-quick-sidebar" class="icon-btn" title="繝・・繝ｫ蛻・崛">笘ｰ</button>
      <button id="btn-quick-theme" class="icon-btn" title="繝・・繝櫁ｨｭ螳・>耳</button>
      <button id="btn-quick-preview" class="icon-btn" title="菫晏ｭ倥・繝ｬ繝薙Η繝ｼ">翌</button>
      <button id="btn-quick-memos" class="icon-btn" title="繝｡繝｢">統</button>
    </div>

    <!-- 繝｡繝｢繝代ロ繝ｫ -->
    <section id="memos-panel" class="memos-panel" hidden>
      <header class="memos-header">
        <h3>繝｡繝｢</h3>
        <select id="memos-sort">
          <option value="createdAt_desc">菴懈・譌･譎・譁ｰ竊呈立)</option>
          <option value="createdAt_asc">菴懈・譌･譎・譌ｧ竊呈眠)</option>
          <option value="rank_desc">鬆・ｽ・鬮倪・菴・</option>
          <option value="rank_asc">鬆・ｽ・菴寂・鬮・</option>
        </select>
        <button id="memos-close" class="icon-btn" title="髢峨§繧・>笨・/button>
      </header>
      <div class="memos-new">
        <input id="memo-label" type="text" placeholder="繝ｩ繝吶Ν" />
        <textarea id="memo-text" rows="3" placeholder="繝｡繝｢譛ｬ譁・></textarea>
        <button id="memo-quote" class="btn" title="繧ｨ繝・ぅ繧ｿ縺ｮ驕ｸ謚樒ｯ・峇繧貞ｼ慕畑">驕ｸ謚槭ｒ蠑慕畑</button>
        <button id="memo-add" class="btn btn-accent">霑ｽ蜉</button>
      </div>
      <div id="memos-list" class="memos-list"></div>
    </section>

    <!-- 菫晏ｭ倥・繝ｬ繝薙Η繝ｼ繝代ロ繝ｫ・医Δ繝・け・・-->
    <section id="preview-panel" class="preview-panel" hidden>
      <header class="preview-header">
        <h3>菫晏ｭ倥・繝ｬ繝薙Η繝ｼ</h3>
        <label class="muted">遞ｮ鬘・          <select id="preview-filter-type">
            <option value="all">縺吶∋縺ｦ</option>
            <option value="simple">繧ｷ繝ｳ繝励Ν</option>
            <option value="full">螳悟・</option>
            <option value="snapshot">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ</option>
          </select>
        </label>
        <label class="muted">荳ｦ縺ｳ
          <select id="preview-sort">
            <option value="date_desc">菫晏ｭ俶律譎・譁ｰ竊呈立)</option>
            <option value="date_asc">菫晏ｭ俶律譎・譌ｧ竊呈眠)</option>
            <option value="size_desc">繧ｵ繧､繧ｺ(螟ｧ竊貞ｰ・</option>
            <option value="size_asc">繧ｵ繧､繧ｺ(蟆鞘・螟ｧ)</option>
          </select>
        </label>
        <div class="spacer"></div>
        <button id="preview-delete-selected" class="btn" disabled>驕ｸ謚槫炎髯､</button>
        <button id="preview-refresh" class="btn">譖ｴ譁ｰ</button>
        <button id="preview-close" class="icon-btn" title="髢峨§繧・>笨・/button>
      </header>
      <div class="snapshot-bar">
        <input id="snapshot-label" type="text" placeholder="繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ縺ｮ繝ｩ繝吶Ν (莉ｻ諢・" />
        <button id="snapshot-create" class="btn btn-accent">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ菴懈・</button>
      </div>
      <div id="preview-list" class="preview-list"></div>
    </section>

    <script src="scripts/storage.js"></script>
    <script src="scripts/theme.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/memos.js"></script>
    <script src="scripts/previewUtils.js"></script>
    <script src="scripts/storageProviders.js"></script>
    <script src="scripts/storageBridge.js"></script>
    <script src="scripts/converters.js"></script>
    <script src="scripts/validator.js"></script>
    <script src="scripts/nodeEditor.js"></script>
    <script src="scripts/savePreview.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="scripts/mermaidPreview.js"></script>
    <script src="scripts/admin.js"></script>
