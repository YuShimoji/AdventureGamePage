<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zenライクエディタ | Adventure Game Admin</title>
    <link rel="stylesheet" href="styles/common.css" />
    <link rel="stylesheet" href="styles/admin.css" />
  </head>
  <body>
    <div class="admin-shell">
      <header class="app-header">
        <div class="header-brand">
          <a class="btn" href="index.html">← トップ</a>
          <div class="header-title">
            <h1>Adventure Game Admin</h1>
            <p class="muted">Zenライクなエディタで物語を構築</p>
          </div>
        </div>
        <div class="header-actions">
          <span id="char-count" class="chip">0 文字</span>
          <button id="btn-theme" class="btn-ghost compact" aria-label="テーマ設定">T</button>
          <button id="btn-toggle-sidebar" class="btn-ghost compact" aria-label="サイドバー切替">S</button>
        </div>
      </header>

      <main class="admin-grid">
        <section class="workspace">
          <article class="card editor-card">
            <header class="editor-toolbar">
              <div class="editor-toolbar-text">
                <h2>本文エディタ</h2>
                <p class="muted">集中してストーリーを執筆できます</p>
              </div>
              <div class="editor-toolbar-actions">
                <button id="btn-quick-zen" class="btn-ghost compact" aria-label="Zenモード切替">ZEN</button>
                <button id="btn-quick-sidebar" class="btn-ghost compact" aria-label="サイドバー切替">SB</button>
                <button id="btn-quick-theme" class="btn-ghost compact" aria-label="テーマ設定">T</button>
                <button id="btn-quick-preview" class="btn-ghost compact" aria-label="保存プレビュー">PV</button>
                <button id="btn-quick-memos" class="btn-ghost compact" aria-label="メモ">ME</button>
              </div>
            </header>
            <div class="editor-surface">
              <div id="editor" class="editor" contenteditable spellcheck="false"></div>
            </div>
            <footer class="editor-status muted">
              <span>フォーカスに合わせて自動スクロールします。設定は右側で調整できます。</span>
            </footer>
          </article>
        </section>

        <aside id="sidebar" class="sidebar">
          <div class="sidebar-scroll">
            <section class="card stack-card">
              <h2>保存と読み込み</h2>
              <label class="field">
                <span>タイトル</span>
                <input id="title-input" type="text" placeholder="タイトルを入力" />
              </label>
              <label class="field">
                <span>保存先</span>
                <select id="storage-provider-select">
                  <option value="idb">IndexedDB（推奨）</option>
                  <option value="local">LocalStorage</option>
                </select>
              </label>
              <div class="actions actions-grid">
                <button id="btn-save-simple" class="btn">シンプル保存</button>
                <button id="btn-load-simple" class="btn">シンプル読込</button>
                <button id="btn-save-full" class="btn btn-accent">完全保存</button>
                <button id="btn-load-full" class="btn">完全読込</button>
                <button id="btn-export" class="btn">エクスポート（JSON）</button>
                <label class="btn file-label">
                  インポート（JSON）
                  <input id="file-import" type="file" accept="application/json" hidden />
                </label>
                <button id="btn-saves-list" class="btn">保存一覧</button>
              </div>
              <section id="validation-panel" class="validation-panel" hidden>
                <h3>検証結果</h3>
                <ul id="validation-list"></ul>
              </section>
            </section>

            <section id="editor-settings" class="card stack-card">
              <h2>エディタ設定</h2>
              <div class="field">
                <label class="muted"><input id="cfg-autoscroll-enabled" type="checkbox" /> 自動スクロールを有効にする</label>
              </div>
              <div class="field">
                <span>セーフゾーン上端 <small id="cfg-safe-top-label">20%</small></span>
                <input id="cfg-safe-top" type="range" min="5" max="40" step="1" value="20" />
              </div>
              <div class="field">
                <span>セーフゾーン下端 <small id="cfg-safe-bottom-label">60%</small></span>
                <input id="cfg-safe-bottom" type="range" min="55" max="90" step="1" value="60" />
              </div>
              <div class="field">
                <label class="muted"><input id="cfg-ink-enabled" type="checkbox" /> インク表示を有効にする</label>
              </div>
              <div class="field">
                <span>インクの表示時間 <small id="cfg-ink-duration-label">160ms</small></span>
                <input id="cfg-ink-duration" type="range" min="0" max="400" step="10" value="160" />
              </div>
              <div class="ne-row">
                <button id="cfg-save" class="btn btn-accent">設定を保存</button>
                <button id="cfg-reset" class="btn">リセット</button>
              </div>
            </section>

            <section id="node-editor" class="card stack-card">
              <h2>ノード編集（MVP）</h2>
              <div class="ne-actions">
                <button id="ne-load" class="btn">agp_game_data を読み込み</button>
                <button id="ne-validate" class="btn">検証</button>
                <button id="ne-save" class="btn btn-accent">適用保存</button>
                <button id="ne-export" class="btn">JSON出力</button>
              </div>
              <div class="ne-banner" id="ne-dirty-banner" hidden>未保存の変更があります。Ctrl+S で保存できます。</div>
              <div class="field">
                <span>開始ノード</span>
                <select id="ne-start-select"></select>
              </div>
              <div class="field ne-unresolved" id="ne-unresolved-panel" hidden>
                <span>未解決 target 一覧</span>
                <ul id="ne-unresolved-list"></ul>
              </div>
              <div class="field">
                <span>ノード一覧</span>
                <div class="ne-row">
                  <select id="ne-node-select"></select>
                  <button id="ne-add-node" class="btn">ノード追加</button>
                  <button id="ne-remove-node" class="btn">ノード削除</button>
                </div>
              </div>
              <div class="field">
                <span>ノードID</span>
                <input id="ne-node-id" type="text" placeholder="node:id" />
              </div>
              <div class="field">
                <span>タイトル</span>
                <input id="ne-node-title" type="text" placeholder="タイトル" />
              </div>
              <div class="field">
                <span>本文</span>
                <textarea id="ne-node-text" rows="4" placeholder="本文"></textarea>
              </div>
              <div class="field">
                <span>選択肢</span>
                <div id="ne-choices" class="ne-choices"></div>
                <button id="ne-add-choice" class="btn">選択肢を追加</button>
              </div>
              <datalist id="ne-node-id-list"></datalist>
              <div class="field">
                <span>部分エクスポート</span>
                <div class="ne-row">
                  <select id="ne-export-multiselect" multiple size="6" style="flex:1"></select>
                  <div class="ne-subactions" style="display:grid; gap:6px;">
                    <button id="ne-export-select-all" class="btn">全選択</button>
                    <button id="ne-export-select-none" class="btn">全解除</button>
                    <button id="ne-export-partial" class="btn">部分エクスポート</button>
                  </div>
                </div>
              </div>
            </section>

            <section id="mermaid-panel" class="card stack-card">
              <h2>Mermaid プレビュー</h2>
              <div class="actions actions-grid">
                <button id="ne-mermaid-gen" class="btn">生成</button>
                <button id="ne-mermaid-render" class="btn">描画</button>
                <button id="ne-mermaid-copy" class="btn">コピー</button>
                <button id="ne-mermaid-download" class="btn">SVGダウンロード</button>
              </div>
              <div class="ne-row" style="margin:6px 0 0;">
                <button id="ne-mermaid-open" class="btn">外部エディタで開く</button>
                <div class="spacer"></div>
              </div>
              <div class="field">
                <span>対象範囲</span>
                <div class="ne-row">
                  <select id="ne-mermaid-scope">
                    <option value="all">全体</option>
                    <option value="from_start">開始ノードから</option>
                    <option value="from_selected">選択ノードを起点</option>
                  </select>
                  <select id="ne-mermaid-seed" multiple size="5" style="flex:1" disabled></select>
                </div>
                <label class="muted"><input id="ne-mermaid-show-labels" type="checkbox" checked /> 選択肢ラベルを表示</label>
              </div>
              <div class="field">
                <span>レイアウト</span>
                <div class="ne-row">
                  <select id="ne-mermaid-dir">
                    <option value="TD">Top-Down (TD)</option>
                    <option value="LR">Left-Right (LR)</option>
                    <option value="TB">Top-Bottom (TB)</option>
                    <option value="RL">Right-Left (RL)</option>
                  </select>
                  <label class="muted"><input id="ne-mermaid-mark-unreachable" type="checkbox" checked /> 到達不能ノードを強調</label>
                </div>
              </div>
              <div class="field">
                <span>検索</span>
                <div class="ne-row" style="gap:8px;">
                  <input id="ne-mermaid-search" type="search" placeholder="ノードID / タイトル / 本文 / 選択肢ラベル" style="flex:1;" />
                  <button id="ne-mermaid-search-clear" class="btn">クリア</button>
                </div>
              </div>
              <div class="field">
                <span>最短経路</span>
                <div class="ne-row" style="gap:8px;">
                  <select id="ne-mermaid-path-start" style="flex:1;"></select>
                  <select id="ne-mermaid-path-goal" style="flex:1;"></select>
                  <button id="ne-mermaid-path-apply" class="btn">経路適用</button>
                </div>
              </div>
              <div class="field">
                <span>ステータス</span>
                <div id="ne-mermaid-status" class="muted" style="min-height:1.6em; display:flex; align-items:center;"></div>
              </div>
              <label class="field">
                <span>Mermaid ソース</span>
                <textarea id="ne-mermaid-src" rows="6" placeholder="flowchart TD..." style="width:100%;"></textarea>
              </label>
              <div class="mermaid-view" id="ne-mermaid-view"></div>
              <p class="muted" style="margin-top:6px;">
                注: Mermaid の描画が失敗した場合はソースを外部エディタで確認してください。
              </p>
            </section>

            <section class="card info-card">
              <p class="muted">詳細な使い方は <a href="docs/help/admin-guide.md" target="_blank">Admin Guide</a> を参照してください。</p>
            </section>
          </div>
        </aside>
      </main>

      <section id="saves-panel" class="saves-panel overlay-panel" hidden>
        <header class="memos-header">
          <h3>保存一覧</h3>
          <button id="saves-refresh" class="btn">再読込</button>
          <button id="saves-close" class="icon-btn" title="閉じる">✕</button>
        </header>
        <div id="saves-list" class="memos-list"></div>
      </section>

      <section id="memos-panel" class="memos-panel overlay-panel" hidden>
        <header class="memos-header">
          <h3>メモ</h3>
          <select id="memos-sort">
            <option value="createdAt_desc">作成日時（新しい順）</option>
            <option value="createdAt_asc">作成日時（古い順）</option>
            <option value="rank_desc">評価（高い順）</option>
            <option value="rank_asc">評価（低い順）</option>
          </select>
          <button id="memos-close" class="icon-btn" title="閉じる">✕</button>
        </header>
        <div class="memos-new">
          <input id="memo-label" type="text" placeholder="タイトル" />
          <textarea id="memo-text" rows="3" placeholder="メモ本文"></textarea>
          <button id="memo-quote" class="btn" title="エディタ選択範囲を引用">選択範囲を引用</button>
          <button id="memo-add" class="btn btn-accent">追加</button>
        </div>
        <div id="memos-list" class="memos-list"></div>
      </section>

      <section id="preview-panel" class="preview-panel overlay-panel" hidden>
        <header class="preview-header">
          <h3>保存プレビュー</h3>
          <label class="muted">フィルター
            <select id="preview-filter-type">
              <option value="all">すべて</option>
              <option value="simple">シンプル保存</option>
              <option value="full">完全保存</option>
              <option value="snapshot">スナップショット</option>
            </select>
          </label>
          <label class="muted">並び替え
            <select id="preview-sort">
              <option value="date_desc">保存日時（新しい順）</option>
              <option value="date_asc">保存日時（古い順）</option>
              <option value="size_desc">サイズ（大→小）</option>
              <option value="size_asc">サイズ（小→大）</option>
            </select>
          </label>
          <div class="spacer"></div>
          <button id="preview-delete-selected" class="btn" disabled>選択削除</button>
          <button id="preview-refresh" class="btn">再読込</button>
          <button id="preview-close" class="icon-btn" title="閉じる">✕</button>
        </header>
        <div class="snapshot-bar">
          <input id="snapshot-label" type="text" placeholder="スナップショット名（任意）" />
          <button id="snapshot-create" class="btn btn-accent">スナップショット作成</button>
        </div>
        <div id="preview-list" class="preview-list"></div>
      </section>
    </div>

    <div id="theme-panel" class="theme-panel" hidden></div>

    <div id="formatbar" class="formatbar-floating">
      <button data-cmd="bold" title="太字"><b>B</b></button>
      <button data-cmd="italic" title="斜体"><i>I</i></button>
      <button data-cmd="underline" title="下線"><u>U</u></button>
      <span class="spacer"></span>
      <button data-cmd="justifyLeft" title="左揃え">左</button>
      <button data-cmd="justifyCenter" title="中央揃え">中</button>
      <button data-cmd="justifyRight" title="右揃え">右</button>
    </div>

    <script src="scripts/storage.js"></script>
    <script src="scripts/theme.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/memos.js"></script>
    <script src="scripts/previewUtils.js"></script>
    <script src="scripts/storageProviders.js"></script>
    <script src="scripts/storageBridge.js"></script>
    <script src="scripts/converters.js"></script>
    <script src="scripts/validator.js"></script>
    <script src="scripts/nodeEditor.js"></script>
    <script src="scripts/dataMigration.js"></script>
    <script src="scripts/savePreview.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="scripts/mermaidPreview.js"></script>
    <script src="scripts/admin.js"></script>
