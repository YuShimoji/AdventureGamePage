<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AdventureGamePage Tests</title>
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
    <style>
      body { background: #111; color: #eee; }
      .container { width: min(980px, 100% - 32px); margin: 16px auto; }
      a { color: #8fd; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>AdventureGamePage Tests</h1>
      <p>Mocha + Chai によるブラウザテスト。サーバーを起動して <code>/tests/test.html</code> を開いてください。</p>
      <div id="mocha"></div>
    </div>

    <!-- App scripts (deps) -->
    <script src="../scripts/storage.js"></script>
    <script src="../scripts/config.js"></script>
    <script src="../scripts/storageProvider.js"></script>
    <script src="../scripts/previewUtils.js"></script>
    <script src="../scripts/converters.js"></script>
    <script src="../scripts/validator.js"></script>
    <script src="../scripts/nodeEditor.js"></script>
    <script src="../scripts/gameEngine.js"></script>

    <!-- Test libs -->
    <script src="https://unpkg.com/mocha/mocha.js"></script>
    <script src="https://unpkg.com/chai/chai.js"></script>
    <script>
      // Mocha setup
      if(window.mocha){ mocha.setup('bdd'); }
      // Fallback expect if chai fails to load
      (function(){
        if(window.chai && window.chai.expect){ window.expect = window.chai.expect; return; }
        console.warn('chai not loaded; using minimal expect polyfill');
        function deepEqual(a,b){
          if(a===b) return true; if(typeof a!==typeof b) return false;
          if(a && b && typeof a==='object'){
            if(Array.isArray(a)){
              if(!Array.isArray(b) || a.length!==b.length) return false;
              for(let i=0;i<a.length;i++){ if(!deepEqual(a[i], b[i])) return false; }
              return true;
            }
            const ak = Object.keys(a), bk = Object.keys(b);
            if(ak.length!==bk.length) return false;
            for(const k of ak){ if(!deepEqual(a[k], b[k])) return false; }
            return true;
          }
          return a==b;
        }
        function deepInclude(obj, subset){
          for(const k in subset){ if(!(k in obj)) return false; if(!deepEqual(obj[k], subset[k])) return false; }
          return true;
        }
        function includeMembers(arr, mems){ return Array.isArray(arr) && mems.every(m => arr.includes(m)); }
        window.expect = function(v){
          return {
            to: {
              equal: (e)=>{ if(v!==e) throw new Error(`expected ${JSON.stringify(v)} to equal ${JSON.stringify(e)}`); },
              be: {
                an: (t)=>{ if(typeof v !== t) throw new Error(`expected type ${t} but got ${typeof v}`); },
                true: ()=>{ if(v!==true) throw new Error('expected true'); },
                false: ()=>{ if(v!==false) throw new Error('expected false'); },
              },
              deep: {
                equal: (e)=>{ if(!deepEqual(v,e)) throw new Error('expected deep equal'); },
                include: (subset)=>{ if(!deepInclude(v,subset)) throw new Error('expected deep include'); },
              },
              include: {
                members: (mems)=>{ if(!includeMembers(v, mems)) throw new Error('expected array to include members'); }
              },
              have: {
                length: (n)=>{ if(!v || v.length!==n) throw new Error(`expected length ${n}, got ${v && v.length}`); }
              },
              exist: ()=>{ if(v==null) throw new Error('expected to exist'); }
            }
          };
        };
      })();
    </script>

    <!-- Tests -->
    <script src="./setup.js"></script>
    <script src="./converters.spec.js"></script>
    <script src="./validator.spec.js"></script>
    <script src="./previewUtils.spec.js"></script>
    <script src="./nodeEditor.spec.js"></script>
    <script src="./storageProvider.spec.js"></script>
    <script src="./gameEngine.spec.js"></script>
    <script src="./gameEngine.back.spec.js"></script>
    <script src="./gameEngine.forward.spec.js"></script>
    <script src="./gameEngine.a11y.spec.js"></script>

    <script>mocha.run();</script>
  </body>
</html>
