<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AdventureGamePage Tests</title>
    <link rel="stylesheet" href="../node_modules/mocha/mocha.css" />
    <style>
      body {
        background: #111;
        color: #eee;
      }
      .container {
        width: min(980px, 100% - 32px);
        margin: 16px auto;
      }
      a {
        color: #8fd;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>AdventureGamePage Tests</h1>
      <p>Mocha + Chai によるブラウザテスト。サーバーを起動して <code>/tests/test.html</code> を開いてください。</p>
      <div id="mocha"></div>
    </div>

    <!-- App scripts (deps) -->
    <script src="../scripts/storage.js"></script>
    <script src="../scripts/config.js"></script>
    <script src="../scripts/errorHandler.js"></script>
    <script src="../scripts/dataValidator.js"></script>
    <script src="../scripts/storageProvider.js"></script>
    <script src="../scripts/previewUtils.js"></script>
    <script src="../scripts/snapshotCompare.js"></script>
    <script src="../scripts/converters.js"></script>
    <script src="../scripts/validator.js"></script>
    <script src="../scripts/nodeEditorUtils.js"></script>
    <script src="../scripts/nodeEditor/ui/readUIRefs.js"></script>
    <script src="../scripts/nodeEditor/ui/forms.js"></script>
    <script src="../scripts/nodeEditor/ui/preview.js"></script>
    <script src="../scripts/nodeEditorUIManager.js"></script>
    <script src="../scripts/nodeEditor.js"></script>
    <script src="../scripts/migrationWizard.js"></script>
    <script src="../scripts/gameEngineLogicManager.js"></script>
    <script src="../scripts/gameEngineUIManager.js"></script>
    <script src="../scripts/gameEngineUtils.js"></script>
    <script src="../scripts/gameEngine.js"></script>

    <!-- Test libs -->
    <script src="../node_modules/mocha/mocha.js"></script>
    <script src="../node_modules/chai/chai.js"></script>
    <script src="../node_modules/sinon/pkg/sinon.js"></script>
    <script>
      // Mocha setup
      if (window.mocha) {
        (function () {
          try {
            const params = new URLSearchParams(window.location.search || '');
            const isE2E = params.get('e2e') === '1';
            if (isE2E) {
              mocha.setup({ ui: 'bdd', reporter: 'spec' });
              return;
            }
          } catch {}
          mocha.setup('bdd');
        })();
      }
      // Fallback expect if chai fails to load
      (function () {
        if (window.chai && window.chai.expect) {
          window.expect = window.chai.expect;
          return;
        }
        console.warn('chai not loaded; using minimal expect polyfill');
        function deepEqual(a, b) {
          if (a === b) return true;
          if (typeof a !== typeof b) return false;
          if (a && b && typeof a === 'object') {
            if (Array.isArray(a)) {
              if (!Array.isArray(b) || a.length !== b.length) return false;
              for (let i = 0; i < a.length; i++) {
                if (!deepEqual(a[i], b[i])) return false;
              }
              return true;
            }
            const ak = Object.keys(a),
              bk = Object.keys(b);
            if (ak.length !== bk.length) return false;
            for (const k of ak) {
              if (!deepEqual(a[k], b[k])) return false;
            }
            return true;
          }
          return a == b;
        }
        function deepInclude(obj, subset) {
          for (const k in subset) {
            if (!(k in obj)) return false;
            if (!deepEqual(obj[k], subset[k])) return false;
          }
          return true;
        }
        function includeMembers(arr, mems) {
          return Array.isArray(arr) && mems.every(m => arr.includes(m));
        }
        window.expect = function (v) {
          return {
            to: {
              equal: e => {
                if (v !== e) throw new Error(`expected ${JSON.stringify(v)} to equal ${JSON.stringify(e)}`);
              },
              be: {
                an: t => {
                  if (typeof v !== t) throw new Error(`expected type ${t} but got ${typeof v}`);
                },
                true: () => {
                  if (v !== true) throw new Error('expected true');
                },
                false: () => {
                  if (v !== false) throw new Error('expected false');
                },
              },
              deep: {
                equal: e => {
                  if (!deepEqual(v, e)) throw new Error('expected deep equal');
                },
                include: subset => {
                  if (!deepInclude(v, subset)) throw new Error('expected deep include');
                },
              },
              include: {
                members: mems => {
                  if (!includeMembers(v, mems)) throw new Error('expected array to include members');
                },
              },
              have: {
                length: n => {
                  if (!v || v.length !== n) throw new Error(`expected length ${n}, got ${v && v.length}`);
                },
              },
              exist: () => {
                if (v == null) throw new Error('expected to exist');
              },
              throw: errLike => {
                if (typeof v !== 'function') throw new Error('expected a function');
                let thrown = null;
                try {
                  v();
                } catch (e) {
                  thrown = e;
                }
                if (!thrown) throw new Error('expected function to throw');
                if (errLike instanceof RegExp) {
                  if (!errLike.test(String((thrown && thrown.message) || thrown)))
                    throw new Error('expected thrown error to match regexp');
                } else if (typeof errLike === 'string') {
                  if (!String((thrown && thrown.message) || thrown).includes(errLike))
                    throw new Error('expected thrown error message to include string');
                } else if (typeof errLike === 'function') {
                  if (!(thrown instanceof errLike))
                    throw new Error('expected thrown error to be instance of provided constructor');
                }
              },
              not: {
                throw: errLike => {
                  if (typeof v !== 'function') throw new Error('expected a function');
                  let thrown = null;
                  try {
                    v();
                  } catch (e) {
                    thrown = e;
                  }
                  if (!thrown) return; // ok
                  if (errLike instanceof RegExp) {
                    if (errLike.test(String((thrown && thrown.message) || thrown)))
                      throw new Error('expected function not to throw matching regexp');
                    return;
                  }
                  if (typeof errLike === 'string') {
                    if (String((thrown && thrown.message) || thrown).includes(errLike))
                      throw new Error('expected function not to throw message including string');
                    return;
                  }
                  if (typeof errLike === 'function') {
                    if (thrown instanceof errLike)
                      throw new Error('expected function not to throw provided constructor');
                    return;
                  }
                  throw new Error('expected function not to throw');
                },
              },
            },
          };
        };
      })();
    </script>

    <!-- Tests -->
    <script src="./setup.js"></script>
    <script src="./converters.spec.js"></script>
    <script src="./validator.spec.js"></script>
    <script src="./previewUtils.spec.js"></script>
    <script src="./nodeEditor.spec.js"></script>
    <script src="./storageProvider.spec.js"></script>
    <script src="./errorHandler.spec.js"></script>
    <script src="./dataValidator.spec.js"></script>
    <script src="./snapshotCompare.spec.js"></script>
    <script src="./migrationWizard.spec.js"></script>
    <script src="./gameEngine.spec.js"></script>
    <script src="./gameEngine.back.spec.js"></script>
    <script src="./gameEngine.forward.spec.js"></script>
    <script src="./gameEngine.a11y.spec.js"></script>
    <script src="./gameEngine.inventory.spec.js"></script>
    <script src="./nodeEditor.api.spec.js"></script>

    <script>
      (function () {
        window.__mochaDone = false;
        window.__mochaStats = { tests: 0, failures: 0 };

        function markFatal(err) {
          if (window.__mochaDone) return;
          window.__mochaStats = {
            tests: 0,
            failures: 1,
            error: String((err && err.message) || err || 'unknown error'),
          };
          window.__mochaDone = true;
        }

        window.addEventListener('error', function (e) {
          markFatal((e && e.error) || (e && e.message) || e);
        });

        window.addEventListener('unhandledrejection', function (e) {
          markFatal((e && e.reason) || e);
        });

        function ensureMochaRoot() {
          let el = document.getElementById('mocha');
          if (el) return el;
          el = document.createElement('div');
          el.id = 'mocha';
          const target = document.body || document.documentElement;
          if (target && typeof target.appendChild === 'function') {
            target.appendChild(el);
          }
          return el;
        }

        function startMocha() {
          if (window.__mochaDone) return;
          ensureMochaRoot();

          if (!window.mocha || typeof window.mocha.run !== 'function') {
            window.__mochaDone = true;
            window.__mochaStats = { tests: 0, failures: 1, error: 'mocha not available' };
            return;
          }

          const runner = mocha.run();
          window.__mochaRunner = runner;

          runner.on('end', function () {
            try {
              const stats = runner.stats || (window.mocha && window.mocha.stats) || {};
              window.__mochaStats = {
                tests: stats.tests || 0,
                failures: stats.failures || 0,
              };
            } catch (e) {
              window.__mochaStats = { tests: 0, failures: 1, error: String((e && e.message) || e) };
            } finally {
              window.__mochaDone = true;
            }
          });
        }

        if (document.readyState === 'complete') {
          startMocha();
        } else {
          window.addEventListener('load', startMocha);
        }
      })();
    </script>
  </body>
</html>
