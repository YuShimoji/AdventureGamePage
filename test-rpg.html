<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AdventureGamePage - RPGã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="styles/play.css" />
    <link rel="stylesheet" href="styles/debug.css" />
  </head>
  <body class="play-page">
    <header class="header">
      <div class="header-content">
        <h1 id="game-title">RPGã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ</h1>
        <div class="header-actions">
          <button id="btn-back" class="btn" aria-label="å‰ã®ãƒãƒ¼ãƒ‰ã«æˆ»ã‚‹">æˆ»ã‚‹</button>
          <button id="btn-forward" class="btn" aria-label="æ¬¡ã®ãƒãƒ¼ãƒ‰ã«é€²ã‚€">é€²ã‚€</button>
          <button
            id="btn-inventory"
            class="btn"
            title="ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª"
            aria-label="ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’é–‹ã"
            aria-expanded="false"
          >
            ğŸ’
          </button>
          <button id="btn-restart" class="btn" aria-label="ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button id="btn-theme" class="icon-btn" title="ãƒ†ãƒ¼ãƒè¨­å®š" aria-label="ãƒ†ãƒ¼ãƒè¨­å®šã‚’é–‹ã">ğŸ¨</button>
          <button id="btn-sample-select" class="btn" title="ã‚µãƒ³ãƒ—ãƒ«é¸æŠ">ğŸ“š ã‚µãƒ³ãƒ—ãƒ«é¸æŠ</button>
          <button id="btn-run-tests" class="btn" title="ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ" style="background: #ff6b6b; color: white">
            ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          </button>
          <label class="btn file-label" aria-label="ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€">
            ã‚²ãƒ¼ãƒ JSONèª­è¾¼
            <input id="play-file-import" type="file" accept="application/json" hidden />
          </label>
        </div>
      </div>
    </header>

    <main class="container play-container">
      <!-- Scene Image -->
      <div id="scene-image" class="scene-image" hidden></div>

      <article id="scene" class="scene" aria-live="polite" aria-atomic="true"></article>
      <div id="choices" class="choices" role="radiogroup" aria-label="é¸æŠè‚¢"></div>
    </main>

    <!-- Inventory Panel -->
    <aside
      id="inventory-panel"
      class="inventory-panel"
      hidden
      role="dialog"
      aria-modal="true"
      aria-labelledby="inventory-header"
    >
      <header class="inventory-header" id="inventory-header">
        <h3>ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3>
        <span id="inventory-count" class="inventory-count" aria-live="polite"></span>
        <button id="inventory-close" class="btn btn-ghost btn-sm" title="é–‰ã˜ã‚‹" aria-label="ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’é–‰ã˜ã‚‹">
          âœ•
        </button>
      </header>
      <div id="inventory-list" class="inventory-list" role="list" aria-label="æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ "></div>
    </aside>

    <!-- Sample Selection Modal -->
    <div id="sample-modal" class="sample-modal" hidden>
      <div class="sample-modal-content">
        <h3>ã‚µãƒ³ãƒ—ãƒ«ã‚²ãƒ¼ãƒ é¸æŠ</h3>
        <div class="sample-list">
          <button class="sample-btn" data-sample="basic">åŸºæœ¬ã‚µãƒ³ãƒ—ãƒ«</button>
          <button class="sample-btn" data-sample="rpg">RPGé¢¨ã‚µãƒ³ãƒ—ãƒ«</button>
          <button class="sample-btn" data-sample="complex">è¤‡é›‘ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</button>
        </div>
        <button id="sample-close" class="btn">é–‰ã˜ã‚‹</button>
      </div>
    </div>

    <aside
      id="theme-panel"
      class="theme-panel"
      hidden
      role="dialog"
      aria-modal="true"
      aria-labelledby="theme-panel-title"
    ></aside>

    <!-- Debug UI -->
    <div id="debug-ui" class="debug-ui" hidden>
      <button id="debug-toggle" class="debug-toggle" title="ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«" aria-label="ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã‚’é–‹ã">
        ğŸ”§
      </button>
      <div id="debug-panel" class="debug-panel" hidden>
        <div class="debug-header">
          <h4>ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h4>
          <button id="debug-close" class="debug-close" aria-label="ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹">âœ•</button>
        </div>
        <div class="debug-content">
          <div class="debug-section">
            <h5>ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h5>
            <div class="debug-buttons">
              <button id="debug-add-item" class="debug-btn">ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </button>
              <button id="debug-remove-item" class="debug-btn">ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤</button>
              <button id="debug-clear-inventory" class="debug-btn">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚¯ãƒªã‚¢</button>
            </div>
          </div>
          <div class="debug-section">
            <h5>ã‚²ãƒ¼ãƒ çŠ¶æ…‹</h5>
            <div class="debug-buttons">
              <button id="debug-save" class="debug-btn">ã‚»ãƒ¼ãƒ–</button>
              <button id="debug-load" class="debug-btn">ãƒ­ãƒ¼ãƒ‰</button>
              <button id="debug-reset" class="debug-btn">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>
          <div class="debug-section">
            <h5>å¤‰æ•°æ“ä½œ</h5>
            <div class="debug-buttons">
              <button id="debug-set-variable" class="debug-btn">å¤‰æ•°è¨­å®š</button>
              <button id="debug-show-variables" class="debug-btn">å¤‰æ•°è¡¨ç¤º</button>
            </div>
          </div>
          <div class="debug-section">
            <h5>ãƒãƒ¼ãƒ‰æ“ä½œ</h5>
            <input id="debug-node-id" type="text" placeholder="ãƒãƒ¼ãƒ‰ID" style="width: 100%; margin-bottom: 8px" />
            <button id="debug-jump-node" class="debug-btn">ãƒãƒ¼ãƒ‰ã‚¸ãƒ£ãƒ³ãƒ—</button>
            <button id="debug-show-state" class="debug-btn">çŠ¶æ…‹è¡¨ç¤º</button>
            <button id="debug-show-inventory" class="debug-btn">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªè¡¨ç¤º</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Status Panel -->
    <div id="test-status" class="test-status">
      <div class="test-info">
        <span id="test-current-node">ç¾åœ¨ã®ãƒãƒ¼ãƒ‰: -</span>
        <span id="test-variables">å¤‰æ•°: -</span>
        <span id="test-inventory">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª: -</span>
      </div>
    </div>

    <script src="scripts/storage.js"></script>
    <script src="scripts/storageProviders.js"></script>
    <script src="scripts/storageBridge.js"></script>
    <script src="scripts/strings.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/mediaResolver.js"></script>
    <script src="scripts/errorHandler.js"></script>
    <script src="scripts/toastManager.js"></script>
    <script src="scripts/themeToggle.js"></script>
    <script src="scripts/audioManager.js"></script>
    <script src="scripts/sampleData.js"></script>
    <script src="scripts/sample-game-rpg.js"></script>
    <script src="scripts/themeUtils.js"></script>
    <script src="scripts/themeUIManager.js"></script>
    <script src="scripts/themeLogicManager.js"></script>
    <script src="scripts/theme.js"></script>
    <script src="scripts/gameEngineLogicManager.js"></script>
    <script src="scripts/gameEngineUIManager.js"></script>
    <script src="scripts/gameEngineUtils.js"></script>
    <script src="scripts/gameEngine.js"></script>
    <script src="scripts/converters.js"></script>
    <script src="scripts/play.core.js"></script>
    <script src="scripts/play.save.js"></script>
    <script src="scripts/play.inventory.js"></script>
    <script src="scripts/play.input.js"></script>
    <script src="scripts/playModalFocus.js"></script>
    <script src="scripts/playModalSaveSlots.js"></script>
    <script src="scripts/play.modal.js"></script>
    <script src="scripts/validator.js"></script>
    <script src="scripts/playImport.js"></script>
    <script src="scripts/debug.js"></script>
    <script src="scripts/tests.js"></script>
    <script>
      // ãƒ†ã‚¹ãƒˆç”¨æ‹¡å¼µ
      (function () {
        const GAME_DATA_KEY = window.APP_CONFIG?.storage?.keys?.gameData || 'agp_game_data';

        function bootWithGameData(gameData) {
          try {
            if (gameData) {
              StorageUtil.saveJSON(GAME_DATA_KEY, gameData);
            }
          } catch (e) {
            console.error(e);
          }

          const result = window.PlayCore && typeof window.PlayCore.init === 'function' ? window.PlayCore.init() : null;
          if (!result || !result.engine) return;

          const engine = result.engine;
          const game = result.game;
          window.gameEngine = engine;

          try {
            if (window.PlaySave && typeof window.PlaySave.init === 'function') {
              window.PlaySave.init(engine, game?.title || 'Adventure');
            }
            if (window.PlayInventory && typeof window.PlayInventory.init === 'function') {
              window.PlayInventory.init(engine);
            }
            if (window.PlayInput && typeof window.PlayInput.init === 'function') {
              window.PlayInput.init(engine);
            }
            if (window.PlayModal && typeof window.PlayModal.init === 'function') {
              window.PlayModal.init({ engine });
            }
          } catch (e) {
            console.error(e);
          }

          window.updateInventoryUI = function () {
            try {
              const list = document.getElementById('inventory-list');
              if (window.PlayInventory && typeof window.PlayInventory.updateInventoryList === 'function') {
                window.PlayInventory.updateInventoryList(list);
              }
            } catch (e) {
              console.error(e);
            }
          };
        }

        // åˆå›ã¯RPGã‚µãƒ³ãƒ—ãƒ«ã‚’å„ªå…ˆã—ã¦èµ·å‹•
        try {
          const existing = StorageUtil.loadJSON(GAME_DATA_KEY);
          if (!existing) {
            const initial = window.SAMPLE_GAME_RPG || window.SAMPLE_GAME;
            if (initial) StorageUtil.saveJSON(GAME_DATA_KEY, initial);
          }
        } catch (e) {
          console.error(e);
        }

        bootWithGameData();

        // ã‚µãƒ³ãƒ—ãƒ«é¸æŠæ©Ÿèƒ½
        const sampleModal = document.getElementById('sample-modal');
        const btnSampleSelect = document.getElementById('btn-sample-select');
        const sampleClose = document.getElementById('sample-close');

        btnSampleSelect?.addEventListener('click', () => {
          sampleModal.hidden = false;
        });

        sampleClose?.addEventListener('click', () => {
          sampleModal.hidden = true;
        });

        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ©Ÿèƒ½
        const btnRunTests = document.getElementById('btn-run-tests');
        btnRunTests?.addEventListener('click', () => {
          if (confirm('ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ãªçµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚')) {
            window.runTests();
          }
        });

        // ã‚µãƒ³ãƒ—ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.querySelectorAll('.sample-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const sampleType = btn.dataset.sample;
            let gameData;

            switch (sampleType) {
              case 'basic':
                gameData = window.SAMPLE_GAME;
                break;
              case 'rpg':
                gameData = window.SAMPLE_GAME_RPG;
                break;
              case 'complex':
                // TODO: ã‚ˆã‚Šè¤‡é›‘ãªã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆ
                alert('è¤‡é›‘ã‚µãƒ³ãƒ—ãƒ«ã¯æº–å‚™ä¸­ã§ã™');
                return;
            }

            try {
              if (gameData) {
                StorageUtil.saveJSON(GAME_DATA_KEY, gameData);
                sampleModal.hidden = true;
                alert(`${btn.textContent}ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                location.reload();
              }
            } catch (e) {
              console.error(e);
            }
          });
        });

        // ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateTestStatus() {
          const statusNode = document.getElementById('test-current-node');
          const statusVars = document.getElementById('test-variables');
          const statusInv = document.getElementById('test-inventory');

          if (window.gameEngine) {
            // ç¾åœ¨ã®ãƒãƒ¼ãƒ‰IDè¡¨ç¤º
            const currentNodeId = window.gameEngine.currentNodeId || 'ä¸æ˜';
            statusNode.textContent = `ç¾åœ¨ã®ãƒãƒ¼ãƒ‰: ${currentNodeId}`;

            // å¤‰æ•°è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
            try {
              const ps = window.gameEngine.getPlayerState ? window.gameEngine.getPlayerState() : {};
              const vars = ps.variables || {};
              const varKeys = Object.keys(vars);
              statusVars.textContent = `å¤‰æ•°: ${varKeys.length}å€‹`;
            } catch (e) {
              statusVars.textContent = 'å¤‰æ•°: ã‚¨ãƒ©ãƒ¼';
            }

            // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªè¡¨ç¤º
            try {
              const inventory = window.gameEngine.getInventory ? window.gameEngine.getInventory() : {};
              const itemCount = inventory.items ? inventory.items.length : 0;
              statusInv.textContent = `ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª: ${itemCount}å€‹`;
            } catch (e) {
              statusInv.textContent = 'ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª: ã‚¨ãƒ©ãƒ¼';
            }
          }
        }

        // å®šæœŸçš„ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        setInterval(updateTestStatus, 1000);
        updateTestStatus();
      })();
    </script>
  </body>
</html>
