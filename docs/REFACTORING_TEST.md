# NodeEditor リファクタリング - テスト手順

## リファクタリング概要

### 完了した作業
1. **DOM参照の分離** - `scripts/nodeEditor/ui/readUIRefs.js`
   - すべてのDOM要素参照を一箇所に集約
   
2. **フォーム描画の分離** - `scripts/nodeEditor/ui/forms.js`
   - `renderActions`: アクション編集フォームの描画（約220行）
   - `renderChoices`: 選択肢編集フォームの描画（約230行）
   - 条件分岐エディタを含む
   
3. **プレビュー機能の分離** - `scripts/nodeEditor/ui/preview.js`
   - `updatePreview`: ゲームプレビュー更新
   - `updateParallelPreview`: 並列プレビュー更新
   - `updateMermaidPreview`: Mermaid図の描画
   - `togglePreview`: プレビューモード切り替え
   - モーダル監視とイベント登録
   
4. **UIマネージャーの簡素化** - `scripts/nodeEditorUIManager.js`
   - 738行 → 172行（約77%削減）
   - 責務: 状態管理、リスト更新、モジュール間の橋渡しのみ
   
5. **スクリプト読み込み順の整理** - `admin.html`
   - 依存関係に基づいた正しい読み込み順序
   - 重複削除（Mermaid CDN）

### モジュール構成

```
scripts/nodeEditor/
├── ui/
│   ├── readUIRefs.js    - DOM参照管理
│   ├── forms.js         - フォーム描画
│   └── preview.js       - プレビュー機能
├── nodeEditorUtils.js   - ユーティリティ
├── nodeEditorUIManager.js   - UI状態管理（簡素化）
├── nodeEditorLogicManager.js - ビジネスロジック
└── nodeEditor.js        - 初期化とAPI公開
```

## テスト手順

### 1. 基本動作確認

#### 1.1 ページ読み込み
```
1. admin.html を開く
2. コンソールにエラーがないことを確認
3. サイドバーが正常に表示されることを確認
```

**期待される結果:**
- エラーなしでページが読み込まれる
- ノードエディタセクションが表示される
- 「NodeEditorUIManager: NodeEditorUIRefs.readUIRefs が見つかりません」などのエラーが出ない

#### 1.2 ノード編集機能
```
1. サイドバーの「ノード編集（MVP）」を開く
2. 「取込」で既存データを読み込む
3. ノード選択ドロップダウンからノードを選択
4. ノードIDを変更してみる
5. タイトル・本文を編集
6. 「保存」でストレージに保存
```

**期待される結果:**
- ノード選択時にフォームが正しく描画される
- 編集内容が即座に反映される
- 未保存バナーが表示される
- 保存後にバナーが消える

### 2. フォーム機能確認

#### 2.1 選択肢の編集
```
1. ノードを選択
2. 「選択肢のテキスト」を入力
3. 「ターゲットノードID」を入力
4. 「条件」ボタンをクリック
5. 条件を追加（例: has_item）
6. 条件の値を設定
7. 上下ボタンで順序を変更
8. 削除ボタンで選択肢を削除
```

**期待される結果:**
- 選択肢が正しく描画される
- 条件エディタが展開・折りたたみできる
- 条件の追加・編集・削除が動作する
- 順序変更が機能する
- 未解決targetパネルが正しく更新される

#### 2.2 アクションの編集
```
1. アクションタイプドロップダウンから「add_item」を選択
2. アイテムIDを入力
3. 個数を設定
4. アクションタイプを「use_item」に変更
5. 「使用時に消費」チェックボックスを確認
6. 効果タイプを選択
7. アクションを削除
```

**期待される結果:**
- アクションタイプに応じてフィールドが表示/非表示される
- ドラッグ&ドロップゾーンが表示される
- アクションの追加・編集・削除が動作する

### 3. プレビュー機能確認

#### 3.1 ゲームプレビュー
```
1. ノードを選択
2. サイドバー内のプレビューを確認
3. タイトル・本文が表示されることを確認
4. 画像URLを設定して画像が表示されることを確認
5. 選択肢ボタンをクリックして遷移を確認
```

**期待される結果:**
- ノード選択時にプレビューが更新される
- 画像が正しく表示される
- 選択肢クリックでノードが切り替わる

#### 3.2 Mermaidプレビュー
```
1. 「フルスクリーン編集」ボタンをクリック
2. モーダルが開くことを確認
3. プレビュー切替ボタン（👁️）をクリック
4. Mermaid図が表示されることを確認
5. 再度切り替えてゲームプレビューに戻る
```

**期待される結果:**
- モーダルが開く
- プレビューモードが切り替わる
- Mermaid図が正しく描画される
- エラーが表示されない

#### 3.3 並列プレビュー
```
1. フルスクリーンモーダル内で編集
2. 右側のプレビューがリアルタイムで更新されることを確認
3. プレビュー更新ボタン（↻）をクリック
4. プレビュー切替をテスト
```

**期待される結果:**
- 並列プレビューが独立して動作する
- 更新ボタンでプレビューが再描画される
- 切り替えが正常に動作する

### 4. 既知の問題と対処

#### 4.1 「プレビューが表示され続ける」問題
**確認方法:**
```
1. モーダルを開く
2. モーダルを閉じる
3. 再度開く
4. プレビューが重複表示されていないか確認
```

**期待される動作:**
- MutationObserver が適切に設定/解除される
- プレビューが1つだけ表示される
- メモリリークが発生しない

#### 4.2 フォント視認性
**確認方法:**
```
1. ダークテーマを適用
2. エディタの文字が読めるか確認
3. プレビューの文字が読めるか確認
```

**対処:**
- 必要に応じて `styles/admin.css` でコントラストを調整
- `.editor`, `.game-node-text` などのセレクタを確認

### 5. パフォーマンステスト

#### 5.1 大量ノード
```
1. 50個以上のノードを含むデータを読み込む
2. ノード選択の応答速度を確認
3. プレビュー更新の速度を確認
```

**期待される結果:**
- 選択時の遅延が1秒未満
- プレビュー更新が即座に反映される
- ブラウザが固まらない

#### 5.2 メモリ使用量
```
1. ブラウザの開発者ツールを開く
2. Performance/Memory タブを確認
3. モーダルの開閉を10回繰り返す
4. メモリが増加し続けていないか確認
```

**期待される結果:**
- メモリリークがない
- モーダル閉鎖時にリスナーが解除される

## トラブルシューティング

### エラー: "NodeEditorUIRefs.readUIRefs が見つかりません"
**原因:** スクリプトの読み込み順が間違っている
**対処:** `admin.html` の読み込み順を確認
```html
<script src="scripts/nodeEditorUtils.js"></script>
<script src="scripts/nodeEditor/ui/readUIRefs.js"></script>  <!-- 先に -->
<script src="scripts/nodeEditor/ui/forms.js"></script>
<script src="scripts/nodeEditor/ui/preview.js"></script>
<script src="scripts/nodeEditorUIManager.js"></script>  <!-- 後に -->
```

### エラー: "Cannot read properties of undefined (reading 'label')"
**原因:** `renderChoices` の変数参照バグ
**対処:** 修正済み（`choice` → `c` のエイリアス化、`label`/`target` 変数定義）

### プレビューが更新されない
**原因:** `preview.updatePreview` の呼び出しに `specData` を渡していない
**対処:** 修正済み（全ての呼び出しに `specData` を追加）

### Mermaidが表示されない
**原因:** Mermaid CDNまたは依存モジュールの読み込み失敗
**対処:** 
1. ネットワークタブでCDNの読み込みを確認
2. MermaidPreview系スクリプトの読み込み順を確認
3. コンソールエラーを確認

## 次のステップ

### 推奨される追加リファクタリング
1. **nodeEditorLogicManager.js の分割**
   - `logic/storage.js`: load/save/export
   - `logic/validation.js`: 検証機能
   - `logic/bindings.js`: イベントバインディング

2. **MermaidPreview の同様の分離**
   - 既に分割されているが、UIマネージャーの簡素化を適用

3. **テストの自動化**
   - Jest または Vitest でユニットテスト
   - Playwright でE2Eテスト

## チェックリスト

テスト完了時に以下を確認:
- [ ] ページが正常に読み込まれる
- [ ] ノードの読み込みが動作する
- [ ] ノードの編集が動作する
- [ ] 選択肢の追加・編集・削除が動作する
- [ ] アクションの追加・編集・削除が動作する
- [ ] 条件エディタが動作する
- [ ] ゲームプレビューが正常に表示される
- [ ] Mermaidプレビューが正常に表示される
- [ ] 並列プレビューが動作する
- [ ] モーダルの開閉が正常に動作する
- [ ] プレビュー重複表示の問題が解消されている
- [ ] メモリリークがない
- [ ] 保存・読み込みが動作する
- [ ] コンソールにエラーがない

## 報告フォーマット

テスト結果は以下の形式で報告:

```
## テスト環境
- ブラウザ: Chrome 120.0.xxxx
- OS: Windows 11
- テスト日時: 2025-11-09 06:30

## テスト結果
### 基本動作: ✅ PASS
- ページ読み込み: OK
- ノード編集: OK
- フォーム描画: OK

### プレビュー機能: ✅ PASS
- ゲームプレビュー: OK
- Mermaidプレビュー: OK
- 並列プレビュー: OK

### 既知問題の確認: ✅ 解消
- プレビュー重複: 解消
- フォント視認性: 要改善（別Issue）

### パフォーマンス: ✅ PASS
- 大量ノード: OK（50ノードで0.3秒）
- メモリ使用: OK（リークなし）

## 発見された問題
なし

## 推奨事項
- CSS調整でフォントコントラストを改善
```
